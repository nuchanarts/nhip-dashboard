import streamlit as st
import pandas as pd
import plotly.express as px

# ==============================
# ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Page
# ==============================
st.set_page_config(
    page_title="NHIP Dashboard",
    layout="wide"
)

st.title("üìä NHIP Dashboard (Google Drive Connected)")

# ==============================
# ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° Google Sheet ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
# ==============================
SPREADSHEET_ID = "1Y4FANer87OduQcK7XctCjJ0FBEKTHlXJ4aMZklcqzFU"
GID = "0"  # ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ sheet ‡∏≠‡∏∑‡πà‡∏ô

url = f"https://docs.google.com/spreadsheets/d/{SPREADSHEET_ID}/export?format=csv&gid={GID}"

try:
    df = pd.read_csv(url)
    df.columns = df.columns.str.strip()
    st.success("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° Google Sheet ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ")
except Exception as e:
    st.error("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ä‡∏£‡πå‡πÅ‡∏ö‡∏ö Anyone with the link ‚Üí Viewer ‡πÅ‡∏•‡πâ‡∏ß")
    st.write(e)
    st.stop()

# ==============================
# ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
# ==============================
st.sidebar.header("‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå")

date_col = st.sidebar.selectbox("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà", df.columns)
province_col = st.sidebar.selectbox("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î", df.columns)
category_col = st.sidebar.selectbox("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó/‡πÅ‡∏ú‡∏ô‡∏Å", df.columns)

df[date_col] = pd.to_datetime(df[date_col], errors="coerce")

# ==============================
# ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á
# ==============================
st.sidebar.header("üîé ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á")

province_filter = st.sidebar.multiselect(
    "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î",
    df[province_col].dropna().unique(),
    default=df[province_col].dropna().unique()
)

category_filter = st.sidebar.multiselect(
    "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó",
    df[category_col].dropna().unique(),
    default=df[category_col].dropna().unique()
)

filtered_df = df[
    (df[province_col].isin(province_filter)) &
    (df[category_col].isin(category_filter))
]

# ==============================
# KPI
# ==============================
col1, col2, col3 = st.columns(3)

col1.metric("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î", len(filtered_df))
col2.metric("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î", filtered_df[province_col].nunique())
col3.metric("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó", filtered_df[category_col].nunique())

st.divider()

# ==============================
# ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
# ==============================
st.subheader("üìã ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•")
st.dataframe(filtered_df, use_container_width=True)

st.divider()

# ==============================
# ‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
# ==============================
st.subheader("üìà ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà")

graph_df = (
    filtered_df
    .groupby(filtered_df[date_col].dt.date)
    .size()
    .reset_index(name="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£")
)

if not graph_df.empty:
    fig = px.line(
        graph_df,
        x=date_col,
        y="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£",
        markers=True
    )
    st.plotly_chart(fig, use_container_width=True)
else:
    st.warning("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏£‡∏≤‡∏ü")
